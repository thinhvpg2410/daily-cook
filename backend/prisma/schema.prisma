generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model User {
  id              String                @id @default(cuid())
  email           String                @unique
  passwordHash    String?
  googleId        String?
  name            String?
  phone           String                @unique
  dob             DateTime?
  avatarUrl       String?
  role            String                @default("USER")
  isTwoFAEnabled  Boolean               @default(false)
  twoFASecret     String?
  recipes         Recipe[]
  mealPlans       MealPlan[]
  preference      UserPreference?
  foodLogs        FoodLog[]
  shoppingLists   ShoppingList[]
  aiLogs          AIRecommendationLog[]
  favoriteRecipes UserFavoriteRecipe[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([createdAt])
}

model UserPreference {
  id                  String   @id @default(cuid())
  userId              String   @unique
  gender              String? // "male" | "female"
  age                 Int?
  height              Int? // cm
  weight              Float? // kg
  activity            String? // "low" | "medium" | "high"
  goal                String? // "lose_weight" | "maintain" | "gain_muscle"
  dailyKcalTarget     Float? // kcal/day
  dietType            String? // "normal" | "vegan" | "low_carb"
  dislikedIngredients String[] @default([])
  likedTags           String[] @default([])
  user                User     @relation(fields: [userId], references: [id])
  updatedAt           DateTime @updatedAt
}

model Ingredient {
  id        String       @id @default(cuid())
  name      String       @unique
  unit      String? // g / ml / tbsp ...
  kcal      Float?       @default(0)
  protein   Float?       @default(0)
  fat       Float?       @default(0)
  carbs     Float?       @default(0)
  fiber     Float?       @default(0)
  sugar     Float?       @default(0)
  sodium    Float?       @default(0)
  items     RecipeItem[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([name])
}

model Recipe {
  id          String               @id @default(cuid())
  title       String
  description String?
  region      String? // "Northern" | "Central" | "Southern"
  cookTime    Int?                 @default(30)
  likes       Int?                 @default(0)
  totalKcal   Float?               @default(0)
  protein     Float?               @default(0)
  fat         Float?               @default(0)
  carbs       Float?               @default(0)
  tags        String[]
  image       String?
  steps       Json?
  authorId    String?
  author      User?                @relation(fields: [authorId], references: [id])
  items       RecipeItem[]
  favorites   UserFavoriteRecipe[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  FoodLog FoodLog[]

  @@index([createdAt])
  @@index([cookTime])
  @@index([likes])
  @@index([region])
  @@index([likes, createdAt])
  @@index([authorId])
}

model RecipeItem {
  id           String     @id @default(cuid())
  recipeId     String
  ingredientId String
  amount       Float
  unitOverride String?
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  recipe       Recipe     @relation(fields: [recipeId], references: [id])
  createdAt    DateTime   @default(now())

  @@index([recipeId])
  @@index([ingredientId])
}

model MealPlan {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime
  note      String?
  slots     Json // { breakfast: [recipeIds], lunch: [...], dinner: [...] }
  totalKcal Float?   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

model ShoppingList {
  id          String   @id @default(cuid())
  title       String   @default("Shopping List")
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  weekStart   DateTime
  weekEnd     DateTime
  items       Json // [{ingredientId, name, qty, unit, checked}]
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, createdAt])
}

model FoodLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime // ngày ăn
  mealType  String // "breakfast" | "lunch" | "dinner" | "snack"
  recipeId  String?
  recipe    Recipe?  @relation(fields: [recipeId], references: [id])
  kcal      Float?
  protein   Float?
  fat       Float?
  carbs     Float?
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([userId, mealType])
  @@index([recipeId])
}

model AIRecommendationLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  input      Json // ex: {date, slot, region, kcalTarget, filters...}
  output     Json // ex: {recipes: [..], totalKcal: 1340}
  modelName  String? // ex: "DailyCook-v1"
  durationMs Int? // thời gian xử lý
  feedback   String? // user feedback ("good", "too salty", etc.)
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@index([modelName])
}

model UserFavoriteRecipe {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
  @@index([userId, createdAt])
}
